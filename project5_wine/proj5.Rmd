---
title: "CUNY SPS DATA 621 - CTG5 - HW5"
author: "Betsy Rosalen, Gabrielle Bartomeo, Jeremy O'Brien, Lidiia Tronina, Rose Koh"
date: "May 15th, 2019"
output:
    bookdown::pdf_document2:
        toc: true
        toc_depth: 2
        number_sections: true
        fig_width: 6
        fig_height: 4
        fig_caption: true
        includes:  
            in_header: ./source/figure_placement.tex
        highlight: haddock
        df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE, echo=FALSE, message=FALSE, warning=FALSE)
chooseCRANmirror(graphics=FALSE, ind=1)
options(scipen=999, digits = 2)
source("./source/libs.R")
source("./source/script.R")
source("./source/script_jeremy.R")
source("./source/script_lidiia.R")
source("./source/script_betsy.R")
source("./source/script_gabby.R")
source("./source/script_rose.R")
source("./source/captioner.R")
#set.seed(123)
```

\newpage

# DATA EXPLORATION

When dining in a restaurant, a sommelier can assist you in selecting a perfect wine, even if you do not know much about wine yourself. By asking about your taste preferences, they can recommend a wine that pairs well with your meal, while complementing your likes and dislikes. But what happens when you’re browsing the 12,000 commercially availible wines as a large wine manufacterer, wondering how to select a good wine. For those who are not familiar with the industry, wine characteristics of the wine may only make selecting a product even more difficult.

The variables are mostly related to the chemical properties of the wine being sold, and for those who are not familiar with the industry, it may only make selecting a product even more difficult. The response variable is the number of sample cases of wine that were purchased by wine distribution companies after sampling a wine. These cases would be used to provide tasting samples to restaurants and wine stores around the United States. 

```{r t1}
knitr::kable(vars_lt, caption="Data Dictionary")
```

## Summary Statistics

Continuous and categorical variables were summarized separately for the sake of clarity.

```{r t2}
knitr::kable(train_num_lt_1 , caption="Summary statistics for numeric variables")
```

`STARS` and `LabelAppeal` can be described as categorical variables. However, because of the numerical coding, these variables has been treated as if it were quantitative. It is best to designate such variables as factors so that they are treated appropriately.

```{r t3}
knitr::kable(train_cat_lt_1 , caption="Summary statistics for categorical variables")
```

### Summary Statistics Graphs

```{r f1, fig.cap="Data Distributions", fig.height=6, fig.width=8}
hist_lt
```

Figure 1 shows the distribution of most of the variables seems normal although we see that the distribution is more peaked than a normal in `Chlorides`, `CitricAcid`, `Density`, `FixedAcidity` , `FreeSulfurDioxide`, `ResidualSugar`, `Sulphates` , `ViolatileAcidity` and  `AcidIndex` have a slight right skew. 

```{r f2, fig.cap = "Scaled Boxplots"}
scaled_boxplots_lt
```

Figure 2 shows that there are a large number of outliers that need to be accounted for, except for `LabelAppeal`, `AcidIndex` and `STARS` which have limited number of variations. 

## Linearity

```{r f3, fig.cap="Scatter plot between numeric predictors and the TARGET", fig.height=7}
linearity_lt 
```

The raw predictors fail to show linear relationship with the `TARGET` except for the `AcidIndex` and `VolativeAcidity`. The Scatter Plots show a systematic, wave-like pattern for `Density`, `FixedAcidity`, `FreeSulfurDioxide`, `TotalSulfurDioxide` and `VolativeAcidity`.

### Log Transformed Data 

```{r f4, fig.cap="Scatter plot between log transformed predictors and the log transformed TARGET filtered for rows where TARGET is greater than 0", fig.height=7}
linearity_log_lt
```

In attempt to improve the linerity of the variables against the  `TARGET` variable, we start with a log transformation on all predictors and`TARGET` variable. As a result, the linearity of `Chlorides` and `FreeSulfurDioxide` become more apparent. 

### Box-Cox

```{r f5, fig.cap="Box-Cox Plot"}
boxcox(TARGET~., data=bc_lt, lambda=seq(-0.2,2,by=0.1))
```

### Square Root Transformed Predictors and Log Transformed Target 

In 'Linear Models with R', Faraway suggested that the square root transformation is often appropriate for count response data. The Poisson distribution is a good model for counts, and that distribution has the property that the mean is equal to the variance thus suggesting the square root transformation. A plot of each predictor square root transformed plotted against the log transformed `TARGET`.  

```{r f6, fig.cap="Scatter plot between square root transformed predictors and the square root transformed TARGET filtered for rows where TARGET is greater than 0", fig.height=7}
linearity_root_lt_2
```

## Missing Data

```{r f7, fig.cap="Missing data", fig.height=6, fig.width=6}
plot_missing(train)
```

A number of variables are missing observations: `STARS`, `Sulphates`, `TotalSulfurDioxide`, `Alcohol`, `FreeSulfurDioxide`, `Chlorides`, `ResidualSugar`, `pH`. For `STARS`, the number is 26.25%, but the others range between 3% and 9% of total.  Approximately 50% of the cases are missing one of these variables.

\newpage


# DATA PREPARATION

```
Describe how you have transformed the data by changing the original variables or creating new variables. If you did transform the data or create new variables, discuss why you did this. Here are some possible transformations.

a. Fix missing values (maybe with a Mean or Median value)

b. Create flags to suggest if a variable was missing

c. Transform data by putting it into buckets

d. Mathematical transforms such as log or square root (or use Box-Cox)

e. Combine variables (such as ratios or adding or multiplying) to create new variables

# [JO: Consider strategies to transform negative variables - arithmetic?]

```

## Missing Values

```{r f8, fig.cap = "Difference between original and imputed data"}
density.plot
```

[Rough explanation] About half of the cases are missing at least one of the following variables: `STARS`, `Sulphates`, `TotalSulfurDioxide`, `Alcohol`, `FreeSulfurDioxide`, `Chlorides`, `ResidualSugar`, or `pH`.  We use MICE (Multivariate Imputation by Chained Equations) to impute values these values based on ... [JO following up]

Pink and blue lines indicate close fit match in distribution of imputed values and recorded values, with the exception of STARS - the addition of STARS values has given the appearance of shifting the distribution from high to low lambda values.


```{r f9, fig.height=9, fig.width=8}
corr.plot2
```


## Transformation / Feature Engineering

There are a large number of negative values for variables for which that is nonsensical, examples: `Alcohol`, `CitricAcid`, `FixedAcidity`, `FreeSulfurDioxide`, `ResidualSugar`, `Sulphates`, `TotalSulfurDioxide`. and `VolatileAcidity`.  The range for the Poisson and negative binomial distribution has zero as a lower bound, so we can arithmetically transform the aforementioned variables to scale the lower IQR non-outlier values from zero up and drop the sub-IQR values (now the only negative values remaining).  [JO currently function not working as intended - moving all points up by the mean - IQR * 1.5, and tossing anything less than that - so tuning calculations]

```{r f10, fig.cap="Data Distributions", fig.height=6, fig.width=8}
hist_lt_scaled
```

(https://www.imachordata.com/do-not-log-transform-count-data-bitches/)

Alternatively, we can explore whether more information on how measurements were made can be found to discern whether there might be some reason for negative values, and if there's a possibility of systematic data errors

We'll also test the data for overdispersion when setting up negative binomial models.  [CODING UNDERWAY]

```{r f11, fig.width = 6, fig.height=6}
#corr.plot
```

\newpage

# BUILD MODELS

```
Using the training data set, build at least two different poisson regression models, at least two different negative binomial regression models, and at least two multiple linear regression models, using different variables (or the same variables with different transformations). Sometimes poisson and negative binomial regression models give the same results. If that is the case, comment on that. Consider changing the input variables if that occurs so that you get different models. Although not covered in class, you may also want to consider building zero-inflated poisson and negative binomial regression models. You may select the variables manually, use an approach such as Forward or Stepwise, use a different approach such as trees, or use a combination of techniques. Describe the techniques you used. If you manually selected a variable for inclusion into the model or exclusion into the model, indicate why this was done.

Discuss the coefficients in the models, do they make sense? In this case, about the only thing you can comment on is the number of stars and the wine label appeal. However, you might comment on the coefficient and magnitude of variables and how they are similar or different from model to model. For example, you might say “pH seems to have a major positive impact in my poisson regression model, but a negative effect in my multiple linear regression model”. Are you keeping the model even though it is counter intuitive? Why? The boss needs to know.
```

\newpage

# SELECT MODELS

```
Decide on the criteria for selecting the best count regression model. Will you select models with slightly worse performance if it makes more sense or is more parsimonious? Discuss why you selected your models.

For the count regression model, will you use a metric such as AIC, average squared error, etc.? Be sure to explain how you can make inferences from the model, and discuss other relevant model output. If you like the multiple linear regression model the best, please say why. However, you must select a count regression model for model deployment. Using the training data set, evaluate the performance of the count regression model. Make predictions using the evaluation data set.
```

## Prediction


\newpage

# Appendix

The appendix is available as script.R file in `project5_wine` folder.

https://github.com/betsyrosalen/DATA_621_Business_Analyt_and_Data_Mining

```
```